<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <style>
      /* .c-camera {
      } */
      .c-camera-video,
      .c-camera-picture {
        width: 300px;
        height: 200px;
        border: solid 1px #ccc;
      }
      .c-camera-button--mode,
      .c-camera-button--shutter {
        text-indent: 110%;
        white-space: nowrap;
        overflow: hidden;

        width: 64px;
        height: 64px;
        background-color: #fff;
        border: solid 1px #333;
        border-radius: 50%;
      }
      /* .c-camera-button--mode {
      }
      .c-camera-button--shutter {
      } */
    </style>

    <div class="c-camera">
      <!-- カメラ映像 -->
      <video id="js-camera-video" class="c-camera-video"></video>
      <canvas id="js-camera-picture" class="c-camera-picture"></canvas>

      <!-- 切り替えボタン -->
      <button id="js-camera-mode" class="c-camera-button--mode" type="button">
        反転する
      </button>
      <button
        id="js-camera-shutter"
        class="c-camera-button--shutter"
        type="button"
      >
        シャッター
      </button>

      <audio id="js-camera-sound" preload="auto">
        <source src="camera-shutter1.mp3" type="audio/mp3" />
      </audio>
    </div>

    <script>
      //---------------------------------------------
      // グローバル変数
      //---------------------------------------------

      const video = document.querySelector("#js-camera-video");
      const canvas = document.querySelector("#js-camera-picture");
      const se = document.querySelector("#js-camera-sound");

      // カメラのデフォルト設定
      const CONSTRAINTS = {
        audio: false,
        video: {
          width: 600,
          height: 400,
          facingMode: null, // どのカメラを利用するか

          // facingModeには最終的に以下のいずれかの値を入れる
          //   facingMode: "user"                    // フロントカメラを利用する
          //   facingMode: { exact: "environment" }  // リアカメラを利用する
        },
      };

      // 現在のStream
      let curSTREAM = null;

      //---------------------------------------------
      // [event] ページ読み込み完了
      //---------------------------------------------
      window.onload = () => {
        let useFront = true; // フロントカメラ:true, バックカメラ:false

        // 縦横の解像度を調整
        adjustCameraSize(video, 640, 480);

        // カメラと同期開始
        syncCamera(video, useFront);
        useFront = !useFront; // boolean値を反転

        //-------------------------------
        // [event] 切り替えボタン押下
        //-------------------------------
        document
          .querySelector("#js-camera-mode")
          .addEventListener("click", () => {
            syncCamera(video, useFront);
            useFront = !useFront; // boolean値を反転
          });
      };

      /**
       * カメラを<video>と同期
       *
       * @param {object} video
       * @param {boolean} [is_front=true]
       */
      function syncCamera(video, is_front = true) {
        // 前後カメラの設定
        CONSTRAINTS.video.facingMode = is_front
          ? "user"
          : { exact: "environment" };

        // すでにカメラと接続していたら停止
        if (curSTREAM !== null) {
          curSTREAM.getVideoTracks().forEach((camera) => {
            camera.stop();
          });
        }

        // カメラと接続する
        navigator.mediaDevices
          .getUserMedia(CONSTRAINTS)
          .then((stream) => {
            curSTREAM = stream; // 前後の切り替え用に保持

            // <video>とStremaを接続
            video.srcObject = stream;
            video.onloadedmetadata = (e) => {
              video.play();
            };
          })
          .catch((err) => {
            console.log(`${err.name}: ${err.message}`);
            alert("カメラとの接続時にエラーが発生しました");
          });
      }

      /**
       * 解像度に合わせて<video>サイズを調整する
       *
       * @param {object}  video
       * @param {integer} longside   長辺のピクセル数
       * @param {integer} shortside  短辺のピクセル数
       **/
      function adjustCameraSize(video, longside, shortside) {
        if (window.innerWidth < window.innerHeight) {
          // getUserMediaに食わせる値
          CONSTRAINTS.video.width = shortside;
          CONSTRAINTS.video.height = longside;
          // videoタグのサイズ
          video.style.width = shortside;
          video.style.height = longside;
        }
      }

      /**
       * シャッターボタン
       */
      document
        .querySelector("#js-camera-shutter")
        .addEventListener("click", () => {
          const ctx = canvas.getContext("2d");

          // 演出的な目的で一度映像を止めてSEを再生する
          video.pause(); // 映像を停止
          se.play(); // シャッター音
          setTimeout(() => {
            video.play(); // 0.5秒後にカメラ再開
          }, 500);

          // canvasに画像を貼り付ける
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        });
    </script>
  </body>
</html>
